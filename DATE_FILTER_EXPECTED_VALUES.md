# 期間フィルター検算 - 期待値一覧

## データの日付分布（2026-01-11現在）

| 顧客 | 注文日 | 経過日数 | ステータス | 金額 | 部署 |
|------|--------|----------|------------|------|------|
| 顧客I | 2026-01-09 | 2日前 | 新規 | ¥8,000 | 103 |
| 顧客A | 2026-01-08 | 3日前 | 新規 | ¥15,000 | 101 |
| 顧客B | 2026-01-06 | 5日前 | 新規 | ¥25,000 | 101 |
| 顧客J | 2026-01-03 | 8日前 | 進行中 | ¥16,000 | 101 |
| 顧客C | 2026-01-01 | 10日前 | 進行中 | ¥18,000 | 102 |
| 顧客D | 2025-12-27 | 15日前 | 進行中 | ¥30,000 | 102 |
| 顧客E | 2025-12-22 | 20日前 | 進行中 | ¥22,000 | 103 |
| 顧客F | 2025-12-17 | 25日前 | 進行中 | ¥12,000 | 103 |
| 顧客G | 2025-12-07 | 35日前 | 遅延 | ¥40,000 | 101 |
| 顧客H | 2025-11-22 | 50日前 | 遅延 | ¥35,000 | 102 |

---

## 期間フィルター別の期待値

### 1️⃣ 全期間（フィルターなし）

**円グラフ:**
| ステータス | 件数 | 合計金額 |
|------------|------|----------|
| 新規 | 3 | ¥48,000 |
| 進行中 | 5 | ¥98,000 |
| 遅延 | 2 | ¥75,000 |

**テーブル（全件）:** 10件

**テーブル（進行中でフィルター）:** 5件（顧客J, C, D, E, F）

---

### 2️⃣ Last 7 days（直近7日間: 2026-01-04 以降）

**対象データ:**
- 顧客I（2日前）
- 顧客A（3日前）
- 顧客B（5日前）

**円グラフ:**
| ステータス | 件数 | 合計金額 |
|------------|------|----------|
| 新規 | 3 | ¥48,000 |

**テーブル（全件）:** 3件

**テーブル（新規でフィルター）:** 3件（顧客I, A, B）

**⚠️ 注意:**
- 「進行中」と「遅延」は0件なので円グラフに表示されない
- 「進行中」をクリックしても何も表示されないはず

---

### 3️⃣ Last 30 days（直近30日間: 2025-12-12 以降）

**対象データ:**
- 顧客I（2日前）
- 顧客A（3日前）
- 顧客B（5日前）
- 顧客J（8日前）
- 顧客C（10日前）
- 顧客D（15日前）
- 顧客E（20日前）
- 顧客F（25日前）

**円グラフ:**
| ステータス | 件数 | 合計金額 |
|------------|------|----------|
| 新規 | 3 | ¥48,000 |
| 進行中 | 5 | ¥98,000 |

**テーブル（全件）:** 8件

**テーブル（進行中でフィルター）:** 5件（顧客J, C, D, E, F）

**⚠️ 注意:**
- 「遅延」は0件なので円グラフに表示されない
- 顧客G（35日前）と顧客H（50日前）は除外される

---

### 4️⃣ 特定期間（例: 2025-12-20 ~ 2026-01-05）

**対象データ:**
- 顧客B（2026-01-06）→ 範囲外
- 顧客J（2026-01-03）→ 範囲内
- 顧客C（2026-01-01）→ 範囲内
- 顧客D（2025-12-27）→ 範囲内
- 顧客E（2025-12-22）→ 範囲内
- 顧客F（2025-12-17）→ 範囲外

**円グラフ:**
| ステータス | 件数 | 合計金額 |
|------------|------|----------|
| 進行中 | 4 | ¥86,000 |

**テーブル（全件）:** 4件（顧客J, C, D, E）

---

## Superset Dashboardでの検証手順

### ステップ1: 期間フィルター追加

1. Dashboard編集モード
2. **Filters** タブ → **+ Add filter**
3. Filter設定:
   - Filter name: `期間フィルター`
   - Filter type: `Time range`
   - Dataset: `orders_with_status`
   - Column: `order_date`
4. **Apply to charts**: 両方のChart（円グラフ + テーブル）を選択
5. Save

### ステップ2: 検証テストケース

#### テスト1: Last 7 days

**操作:**
1. 期間フィルターで「Last 7 days」を選択
2. 円グラフを確認

**期待結果:**
```
✅ 円グラフ: 新規のみ表示（¥48,000）
✅ テーブル: 3件（顧客I, A, B）
```

**実際の結果を記録:**
- 円グラフ: [ 新規: ¥_______ ]
- テーブル件数: [ ___ 件 ]

---

#### テスト2: Last 30 days + クロスフィルター

**操作:**
1. 期間フィルターで「Last 30 days」を選択
2. 円グラフで「進行中」をクリック

**期待結果:**
```
✅ 円グラフ: 新規（¥48,000）+ 進行中（¥98,000）
✅ テーブル: 5件（顧客J, C, D, E, F）のみ
✅ 全て status = '進行中'
```

**実際の結果を記録:**
- 円グラフ: [ 新規: ¥_______, 進行中: ¥_______ ]
- テーブル件数: [ ___ 件 ]
- テーブル表示顧客: [ _________ ]

---

#### テスト3: 全期間 + クロスフィルター

**操作:**
1. 期間フィルターを解除（または「No filter」）
2. 円グラフで「遅延」をクリック

**期待結果:**
```
✅ 円グラフ: 新規（¥48,000）+ 進行中（¥98,000）+ 遅延（¥75,000）
✅ テーブル: 2件（顧客G, H）のみ
✅ 全て status = '遅延'
```

**実際の結果を記録:**
- 円グラフ: [ 新規: ¥_______, 進行中: ¥_______, 遅延: ¥_______ ]
- テーブル件数: [ ___ 件 ]
- テーブル表示顧客: [ _________ ]

---

## 重要な検証ポイント

### ✅ 確認すべきこと

1. **期間フィルターが元データに適用されているか**
   - Last 7 days → 新規のみ表示される
   - Last 30 days → 遅延が表示されない

2. **ステータス計算が期間フィルター後のデータで正しく行われているか**
   - 期間フィルターで絞り込んだ後、CASE WHENでステータス計算

3. **クロスフィルターが期間フィルターと併用できるか**
   - 期間フィルター + ステータスクリック → 両方適用される

4. **金額の合計が正しいか**
   - 各ステータスの合計金額が期待値と一致する

---

## SQLで直接確認する方法

Superset SQL Labで以下を実行して期待値を確認できます：

```sql
-- Last 30 days の期待値
SELECT
    status,
    COUNT(*) as count,
    SUM(amount) as total_amount,
    STRING_AGG(customer_name, ', ' ORDER BY order_date DESC) as customers
FROM (
    SELECT
        customer_name,
        order_date,
        amount,
        CASE
            WHEN (CURRENT_DATE - order_date) < 7 THEN '新規'
            WHEN (CURRENT_DATE - order_date) < 30 THEN '進行中'
            ELSE '遅延'
        END AS status
    FROM orders
    WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
) AS orders_with_status
GROUP BY status
ORDER BY status;
```

---

**検証日**: 2026-01-11
**検証者**: [ 記入してください ]

**結果**:
- [ ] ✅ 期待通りに動作している
- [ ] ❌ 問題あり（詳細: ___________________）
